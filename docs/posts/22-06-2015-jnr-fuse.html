<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>JNR-FUSE library for using FUSE from Java - Sergey Tselovalnikov</title><meta content="Empty" name="description"/><meta property="og:url" content="https://serce.me/posts/22-06-2015-jnr-fuse"/><link rel="canonical" href="https://serce.me/posts/22-06-2015-jnr-fuse"/><meta property="og:type" content="article"/><meta property="og:site_name" content="JNR-FUSE library for using FUSE from Java - Sergey Tselovalnikov"/><meta property="og:description" content="Empty"/><meta property="og:title" content="JNR-FUSE library for using FUSE from Java - Sergey Tselovalnikov"/><meta property="og:image" content="https://serce.meundefined"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@SerCeMan"/><meta name="twitter:title" content="JNR-FUSE library for using FUSE from Java - Sergey Tselovalnikov"/><meta name="twitter:description" content="Empty"/><meta name="twitter:image" content="https://serce.meundefined"/><meta property="article:published_time" content="2015-06-22"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/59694621ebf097fb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/59694621ebf097fb.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8aea71f50af9d276.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8aea71f50af9d276.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-70187573dbb2adba.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9d9bd6946354a189.js" defer=""></script><script src="/_next/static/chunks/105-7a67388502189cf8.js" defer=""></script><script src="/_next/static/chunks/675-25da51e9f406e7b5.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-f663f3a9eda66be0.js" defer=""></script><script src="/_next/static/Pcyft9E01JztMB997G3j_/_buildManifest.js" defer=""></script><script src="/_next/static/Pcyft9E01JztMB997G3j_/_ssgManifest.js" defer=""></script></head><body style="background-color:#f2f2f2" class="bg-white text-gray-900"><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if(e){c.add(e|| '')}else{c.add('light');}if(e==='light'||e==='dark'||!e)d.style.colorScheme=e||'light'}catch(t){}}();</script><header style="background-color:#f8f8f8" class="relative shadow-md"><div class="max-w-5xl px-8 py-1 mx-auto"><div class="flex items-center justify-between"><nav class="flex justify-between items-center w-full text-lg"><a style="font-family:Alegreya" class="text-gray-500 pr-6 py-4 float-left w-1/2 text-4xl" href="/">SerCe&#x27;s blog</a><div class="float-right"><a class="text-gray-600 px-6 py-4" href="/">Home</a><a class="text-gray-600 px-6 py-4" href="/blog">Blog</a><a class="text-gray-600 px-6 py-4" href="/talks">Talks</a></div></nav></div></div></header><main><div><article class="container mx-auto mt-12 px-10 py-8 shadow-md bg-white max-w-5xl flex flex-col"><p class="self-start text-sm text-gray-500">22 June 2015</p><div class="asciiprose"><h1 class="text-gray-900">JNR-FUSE library for using FUSE from Java</h1><p>Hi!</p>
<p>In this article, I’ll tell you how to implement userspace file system
using Java without a line of kernel space code. I’ll also show you how
to connect Java and native code without writing C code and save maximum
performance.</p>
<p>Originally, I posted this article on
<a href="https://habrahabr.ru/post/260801/">habrahabr</a> (in Russian).</p>
<p><img src="/images/jnr-fuse/jackie.jpg" alt=""/></p>
<h2 id="fuse"><a class="anchor" href="#fuse"><span class="icon icon-link"></span></a>FUSE</h2>
<p>First of all, it is important to understand what FUSE is. FUSE -
FileSystem in Userspace - helps users without any privileges to create
their file system without a necessity to write code in a kernel space.</p>
<p>This is possible because the filesystem code runs in userspace. And the
FUSE module is just a bridge between the kernel API and your code. FUSE
was officially included in the Linux source tree in 2.6.14.</p>
<p><img src="/images/jnr-fuse/bridge.png" alt=""/></p>
<p>So, you can easily create your own filesystem (<a href="https://github.com/libfuse/libfuse/blob/master/example/hello.c">here is the simplest
example</a>).
There are a lot of areas where you can use it. For example, you can
quickly write a FS where Github or DropBox would be the backend.</p>
<p>Or, let’s imagine, you have a business application where all user files
are stored in a database. But your client wants to have access to them
from a filesystem on the server. Of course to duplicate files in the
filesystem and the database is the wrong decision. And here FUSE comes
in; you just need a little FUSE program which handles all user requests
to the directory and redirects them to the database.</p>
<h2 id="java-and-native-code"><a class="anchor" href="#java-and-native-code"><span class="icon icon-link"></span></a>Java and native code</h2>
<p>So far so good. But implementation of FUSE starts from &quot;include header
&lt;fuse.h&gt;&quot;. But your business application is written in Java.
Obviously, it is necessary to communicate with the native code.</p>
<h3 id="jni"><a class="anchor" href="#jni"><span class="icon icon-link"></span></a>JNI</h3>
<p>The standard tool for a native communication in Java is JNI. But it
brings a lot of complexity. Especially because for using FUSE we need a
lot of callbacks from the native code to Java. And &quot;write once&quot; is
suffering in this case (However, in the case of FUSE it is not so
important). If you try to find projects that implement a FUSE wrapper
using JNI you will find a few projects, but they have been obsolete for
a long time. And their API is very inconvenient.</p>
<h3 id="jna"><a class="anchor" href="#jna"><span class="icon icon-link"></span></a>JNA</h3>
<p>Another option is <a href="https://github.com/java-native-access/jna">JNA
library</a>. JNA (Java Native
Access) gives you the possibility to get access to the native code
easily without using JNI only by using Java code. It is very easy; you
just need to declare an interface which matches the native code and get
an implementation through &quot;Native.loadLibrary&quot;. And that’s all. Another
advantage of JNA is very detailed documentation. The project is alive,
and it is in active development.</p>
<p>Moreover, a good project implementing FUSE using JNA already exists. But
JNA has a lot of problems with performance. JNA is reflection based, so
jumping from native code to Java code with data conversion is very
expensive. It is not so important if native calls are rare. But a FS has
a lot of native calls. The only way to speed up fuse-jna is to read
files using big chunks, but it doesn’t always work. For example, when
you have no access to a client’s code or when all files are small.
Obviously, we need a library that combines JNI performance and JNA
convenience.</p>
<h3 id="jnr"><a class="anchor" href="#jnr"><span class="icon icon-link"></span></a>JNR</h3>
<p>And here is where JNR (Java Native Runtime) comes in. JNR, like JNA, is
based on libffi library, but it uses a bytecode generation instead of
reflection. And as a result, JNR achieves excellent performance. The
information about JNR is very limited. The most detailed piece of
information is <a href="http://medianetwork.oracle.com/video/player/2630340184001">Charles Nutter’s talk on JVMLS
2013</a>. But
despite the lack of information, JNR is already a big ecosystem actively
used by JRuby. A lot of jnr-based libraries such as unix-sockets and
posix-api are actively used by different projects.</p>
<p><img src="/images/jnr-fuse/jnr.png" alt=""/></p>
<p>JNR is a library which became a basis for the development of <a href="http://openjdk.java.net/jeps/191">JEP 191 -
Foreign Function Interface</a>, which is
targeted for Java 10. In comparison to JNA, JNR has no proper
documentation, and you need to look for answers in the source code. That
is the main reason for this mini-guide.</p>
<h1 id="specialties-of-writing-code-using-java-native-runtime"><a class="anchor" href="#specialties-of-writing-code-using-java-native-runtime"><span class="icon icon-link"></span></a>Specialties of writing code using Java Native Runtime</h1>
<h2 id="function-binding"><a class="anchor" href="#function-binding"><span class="icon icon-link"></span></a>Function binding</h2>
<p><em>The simplest binding</em></p>
<pre><code class="hljs language-java"><span class="hljs-keyword">import</span> jnr.ffi.*;
<span class="hljs-keyword">import</span> jnr.ffi.types.pid_t;

<span class="hljs-comment">/**
 * Gets the process ID of the current process, and that of its parent.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Getpid</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LibC</span>  {
        <span class="hljs-keyword">public</span> <span class="hljs-meta">@pid_t</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getpid</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-meta">@pid_t</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getppid</span><span class="hljs-params">()</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">LibC</span> <span class="hljs-variable">libc</span> <span class="hljs-operator">=</span> LibraryLoader.create(LibC.class).load(<span class="hljs-string">&quot;c&quot;</span>);

        System.out.println(<span class="hljs-string">&quot;pid=&quot;</span> + libc.getpid() + <span class="hljs-string">&quot; parent pid=&quot;</span> + libc.getppid());
    }
}
</code></pre>
<p>Here we are the loading java library which matches the native interface
by name.</p>
<p>In the case of FUSE, we need an interface with method fuse_main_real
where FuseOperations structure with all callbacks passes as an argument.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LibFuse</span> {
    <span class="hljs-type">int</span> <span class="hljs-title function_">fuse_main_real</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, String argv[], FuseOperations op, <span class="hljs-type">int</span> op_size, Pointer user_data)</span>;
}
</code></pre>
<h3 id="implementation-of-structures"><a class="anchor" href="#implementation-of-structures"><span class="icon icon-link"></span></a>Implementation of structures</h3>
<p>Often you need to work with structure which is located at a certain
address, for example with fuse_bufvec structure:</p>
<pre><code class="hljs language-c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_bufvec</span> {</span>
    <span class="hljs-type">size_t</span> count;
    <span class="hljs-type">size_t</span> idx;
    <span class="hljs-type">size_t</span> off;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_buf</span> <span class="hljs-title">buf</span>[1];</span>
};
</code></pre>
<p>For its implementation, we need to make a successor of jnr.ffi.Struct.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">import</span> jnr.ffi.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FuseBufvec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Struct</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FuseBufvec</span><span class="hljs-params">(jnr.ffi.Runtime runtime)</span> {
        <span class="hljs-built_in">super</span>(runtime);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">size_t</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">size_t</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">size_t</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">size_t</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">size_t</span> <span class="hljs-variable">off</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">size_t</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">FuseBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> inner(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FuseBuf</span>(getRuntime()));
}
</code></pre>
<p>After that, you have to set proper callback implementation into the
getattr field.</p>
<pre><code class="hljs language-java">fuseOperations.getattr.set((path, stbuf) -&gt; <span class="hljs-number">0</span>);
</code></pre>
<h3 id="enum"><a class="anchor" href="#enum"><span class="icon icon-link"></span></a>Enum</h3>
<p>Enum implementation is not so obvious as other parts of the library. You
need to inherit your enum from jnr.ffi.util.EnumMapper.IntegerEnum and
implement method intValue</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">fuse_buf_flags</span> {
    FUSE_BUF_IS_FD    = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>),
    FUSE_BUF_FD_SEEK    = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>),
    FUSE_BUF_FD_RETRY    = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>),
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FuseBufFlags</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnumMapper</span>.IntegerEnum {
    FUSE_BUF_IS_FD(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>),
    FUSE_BUF_FD_SEEK(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>),
    FUSE_BUF_FD_RETRY(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;

    FuseBufFlags(<span class="hljs-type">int</span> value) {
        <span class="hljs-built_in">this</span>.value = value;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">intValue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> value;
    }
}
</code></pre>
<h3 id="work-with-memory"><a class="anchor" href="#work-with-memory"><span class="icon icon-link"></span></a>Work with memory</h3>
<ul>
<li>For working with direct memory wrapper jnr.ffi.Pointer exists.</li>
<li>You can allocate memory using jnr.ffi.Memory</li>
<li>The entry point of JNR API learning is jnr.ffi.Runtime</li>
</ul>
<p>This knowledge is enough to implement a simple cross-platform wrapper
for some native library.</p>
<h2 id="jnr-fuse"><a class="anchor" href="#jnr-fuse"><span class="icon icon-link"></span></a>JNR-FUSE</h2>
<p>What I’ve implemented is a FUSE wrapper in my project jnr-fuse.
Previously I used fuse-jna, but it was a bottleneck in the FS
implementation. During the development, I tried to save compatibility
with the native interface (&lt;fuse.h&gt;).</p>
<p>For implementing your own file system, you need to extend
ru.serce.jnrfuse.FuseStubFS and implement several methods.
Fuse_operations contain <a href="http://fuse.sourcearchive.com/documentation/2.8.4-1.4ubuntu1/structfuse__operations.html">a lot of
methods</a>,
but for getting your FS up and running, you just need to implement
several methods. It is very easy, <a href="https://github.com/SerCeMan/jnr-fuse/tree/master/src/main/java/ru/serce/jnrfuse/examples">here are some
examples</a>.</p>
<p>Currently, only Linux is supported (x86 and x64).</p>
<p>Library exists in JCenter.</p>
<p><em>Gradle</em></p>
<pre><code class="hljs language-kotlin">repositories {
    jcenter()
}

dependencies {
    compile <span class="hljs-string">&#x27;com.github.serceman:jnr-fuse:0.1&#x27;</span>
}
</code></pre>
<p><em>Maven</em></p>
<pre><code class="hljs language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>bintray<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://jcenter.bintray.com<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.serceman<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jnr-fuse<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 id="jnr-fuse-and-fuse-jna-performance-comparison"><a class="anchor" href="#jnr-fuse-and-fuse-jna-performance-comparison"><span class="icon icon-link"></span></a>JNR-FUSE and FUSE-JNA performance comparison</h3>
<p>In my case the FS was read-only, and I was interested in throughput. The
performance will mostly depend on your FS implementation, so if you
already use fuse-jna, you’ll be able to change it easily to jnr-fuse,
write a test, and to see the performance difference on your workload.
(It will be helpful anyway because we all love to achieve new levels of
performance, right?)</p>
<p>In order to show performance the difference, I moved MemoryFS
implementation from fuse-jna to jnr-fuse with minimal changes and ran a
reading test. For the test, I used
<a href="http://freecode.com/projects/fio">fio</a> framework.</p>
<details><summary>Test configuration</summary><pre><code class="">[readtest]
blocksize=4k
directory=/tmp/mnt/
rw=randread
direct=1
buffered=0
ioengine=libaio
time_based=60
size=16M
runtime=60
</code></pre></details>
<details><summary>The result of of fuse-jna</summary><pre><code class="">serce@SerCe-FastLinux:~/git/jnr-fuse/bench$ fio read.ini
readtest: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=1
fio-2.1.3
Starting 1 process
readtest: Laying out IO file(s) (1 file(s) / 16MB)
Jobs: 1 (f=1): [r] [100.0% done] [24492KB/0KB/0KB /s] [6123/0/0 iops] [eta 00m:00s]
readtest: (groupid=0, jobs=1): err= 0: pid=10442: Sun Jun 21 14:49:13 2015
read: io=1580.2MB, bw=26967KB/s, iops=6741, runt= 60000msec
slat (usec): min=46, max=29997, avg=146.55, stdev=327.68
clat (usec): min=0, max=69, avg= 0.47, stdev= 0.66
lat (usec): min=47, max=30002, avg=147.26, stdev=327.88
clat percentiles (usec):
| 1.00th=[ 0], 5.00th=[ 0], 10.00th=[ 0], 20.00th=[ 0],
| 30.00th=[ 0], 40.00th=[ 0], 50.00th=[ 0], 60.00th=[ 1],
| 70.00th=[ 1], 80.00th=[ 1], 90.00th=[ 1], 95.00th=[ 1],
| 99.00th=[ 2], 99.50th=[ 2], 99.90th=[ 3], 99.95th=[ 12],
| 99.99th=[ 14]
bw (KB /s): min=17680, max=32606, per=96.09%, avg=25913.26, stdev=3156.20
lat (usec): 2=97.95%, 4=1.96%, 10=0.02%, 20=0.06%, 50=0.01%
lat (usec): 100=0.01%
cpu: usr=1.98%, sys=5.94%, ctx=405302, majf=0, minf=28
IO depths: 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%
submit: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
complete: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
issued: total=r=404511/w=0/d=0, short=r=0/w=0/d=0

Run status group 0 (all jobs):
READ: io=1580.2MB, aggrb=26967KB/s, minb=26967KB/s, maxb=26967KB/s, mint=60000msec, maxt=60000msec
</code></pre></details>
<details><summary>The result of jnr-fuse</summary><pre><code class="">serce@SerCe-FastLinux:~/git/jnr-fuse/bench$ fio read.ini
readtest: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=1
fio-2.1.3
Starting 1 process
readtest: Laying out IO file(s) (1 file(s) / 16MB)
Jobs: 1 (f=1): [r] [100.0% done] [208.5MB/0KB/0KB /s] [53.4K/0/0 iops] [eta 00m:00s]
readtest: (groupid=0, jobs=1): err= 0: pid=10153: Sun Jun 21 14:45:17 2015
read: io=13826MB, bw=235955KB/s, iops=58988, runt= 60002msec
slat (usec): min=6, max=23671, avg=15.80, stdev=19.97
clat (usec): min=0, max=1028, avg= 0.37, stdev= 0.78
lat (usec): min=7, max=23688, avg=16.29, stdev=20.03
clat percentiles (usec):
| 1.00th=[ 0], 5.00th=[ 0], 10.00th=[ 0], 20.00th=[ 0],
| 30.00th=[ 0], 40.00th=[ 0], 50.00th=[ 0], 60.00th=[ 0],
| 70.00th=[ 1], 80.00th=[ 1], 90.00th=[ 1], 95.00th=[ 1],
| 99.00th=[ 1], 99.50th=[ 1], 99.90th=[ 2], 99.95th=[ 2],
| 99.99th=[ 10]
lat (usec): 2=99.88%, 4=0.10%, 10=0.01%, 20=0.01%, 50=0.01%
lat (usec): 100=0.01%, 250=0.01%
lat (msec): 2=0.01%
cpu: usr=9.33%, sys=34.01%, ctx=3543137, majf=0, minf=28
IO depths: 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%
submit: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
complete: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
issued: total=r=3539449/w=0/d=0, short=r=0/w=0/d=0

Run status group 0 (all jobs):
READ: io=13826MB, aggrb=235955KB/s, minb=235955KB/s, maxb=235955KB/s, mint=60002msec, maxt=60002msec
</code></pre></details>
<p><img src="/images/jnr-fuse/table.png" alt=""/></p>
<p>The only information this test shows us is the difference in reading a
file using fuse-jna and jnr-fuse, but it gives us an understanding of
the level of performance difference of JNA and JNR. If you are
interested, you can write a more detailed test for native calls using
the <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> tool.</p>
<p>The performance differences in throughput and latency are about ~10
times. Charles Nutter in his presentation gave us the same numbers.</p>
<h3 id="references"><a class="anchor" href="#references"><span class="icon icon-link"></span></a>References</h3>
<ul>
<li><a href="https://github.com/libfuse/libfuse">FUSE on GitHub</a></li>
<li><a href="https://github.com/jnr">JNR on GitHub</a></li>
<li><a href="http://www.oracle.com/technetwork/java/jvmls2013nutter-2013526.pdf">Charles Nutter presentation about JNR</a></li>
<li><a href="http://openjdk.java.net/jeps/191">JEP 191</a></li>
<li><a href="https://github.com/SerCeMan/jnr-fuse/blob/master/src/main/java/ru/serce/jnrfuse/examples/HelloFuse.java">Java HelloFuse</a>
/<a href="https://github.com/libfuse/libfuse/blob/master/example/hello.c">CHelloFuse</a></li>
</ul>
<p>The <a href="https://github.com/SerCeMan/jnr-fuse">jnr-fuse</a> project is located
on GitHub. I’ll appreciate stars, pull-requests, and comments. I’ll be
glad to answer any questions you have about JNR or jnr-fuse.</p></div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"source":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    a: \"a\",\n    img: \"img\",\n    h2: \"h2\",\n    span: \"span\",\n    h3: \"h3\",\n    h1: \"h1\",\n    em: \"em\",\n    pre: \"pre\",\n    code: \"code\",\n    ul: \"ul\",\n    li: \"li\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: \"Hi!\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In this article, I’ll tell you how to implement userspace file system\\nusing Java without a line of kernel space code. I’ll also show you how\\nto connect Java and native code without writing C code and save maximum\\nperformance.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Originally, I posted this article on\\n\", _jsx(_components.a, {\n        href: \"https://habrahabr.ru/post/260801/\",\n        children: \"habrahabr\"\n      }), \" (in Russian).\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/images/jnr-fuse/jackie.jpg\",\n        alt: \"\"\n      })\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"fuse\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#fuse\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"FUSE\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"First of all, it is important to understand what FUSE is. FUSE -\\nFileSystem in Userspace - helps users without any privileges to create\\ntheir file system without a necessity to write code in a kernel space.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This is possible because the filesystem code runs in userspace. And the\\nFUSE module is just a bridge between the kernel API and your code. FUSE\\nwas officially included in the Linux source tree in 2.6.14.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/images/jnr-fuse/bridge.png\",\n        alt: \"\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"So, you can easily create your own filesystem (\", _jsx(_components.a, {\n        href: \"https://github.com/libfuse/libfuse/blob/master/example/hello.c\",\n        children: \"here is the simplest\\nexample\"\n      }), \").\\nThere are a lot of areas where you can use it. For example, you can\\nquickly write a FS where Github or DropBox would be the backend.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Or, let’s imagine, you have a business application where all user files\\nare stored in a database. But your client wants to have access to them\\nfrom a filesystem on the server. Of course to duplicate files in the\\nfilesystem and the database is the wrong decision. And here FUSE comes\\nin; you just need a little FUSE program which handles all user requests\\nto the directory and redirects them to the database.\"\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"java-and-native-code\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#java-and-native-code\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Java and native code\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"So far so good. But implementation of FUSE starts from \\\"include header\\n\u003cfuse.h\u003e\\\". But your business application is written in Java.\\nObviously, it is necessary to communicate with the native code.\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"jni\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#jni\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"JNI\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The standard tool for a native communication in Java is JNI. But it\\nbrings a lot of complexity. Especially because for using FUSE we need a\\nlot of callbacks from the native code to Java. And \\\"write once\\\" is\\nsuffering in this case (However, in the case of FUSE it is not so\\nimportant). If you try to find projects that implement a FUSE wrapper\\nusing JNI you will find a few projects, but they have been obsolete for\\na long time. And their API is very inconvenient.\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"jna\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#jna\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"JNA\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Another option is \", _jsx(_components.a, {\n        href: \"https://github.com/java-native-access/jna\",\n        children: \"JNA\\nlibrary\"\n      }), \". JNA (Java Native\\nAccess) gives you the possibility to get access to the native code\\neasily without using JNI only by using Java code. It is very easy; you\\njust need to declare an interface which matches the native code and get\\nan implementation through \\\"Native.loadLibrary\\\". And that’s all. Another\\nadvantage of JNA is very detailed documentation. The project is alive,\\nand it is in active development.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Moreover, a good project implementing FUSE using JNA already exists. But\\nJNA has a lot of problems with performance. JNA is reflection based, so\\njumping from native code to Java code with data conversion is very\\nexpensive. It is not so important if native calls are rare. But a FS has\\na lot of native calls. The only way to speed up fuse-jna is to read\\nfiles using big chunks, but it doesn’t always work. For example, when\\nyou have no access to a client’s code or when all files are small.\\nObviously, we need a library that combines JNI performance and JNA\\nconvenience.\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"jnr\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#jnr\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"JNR\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"And here is where JNR (Java Native Runtime) comes in. JNR, like JNA, is\\nbased on libffi library, but it uses a bytecode generation instead of\\nreflection. And as a result, JNR achieves excellent performance. The\\ninformation about JNR is very limited. The most detailed piece of\\ninformation is \", _jsx(_components.a, {\n        href: \"http://medianetwork.oracle.com/video/player/2630340184001\",\n        children: \"Charles Nutter’s talk on JVMLS\\n2013\"\n      }), \". But\\ndespite the lack of information, JNR is already a big ecosystem actively\\nused by JRuby. A lot of jnr-based libraries such as unix-sockets and\\nposix-api are actively used by different projects.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/images/jnr-fuse/jnr.png\",\n        alt: \"\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"JNR is a library which became a basis for the development of \", _jsx(_components.a, {\n        href: \"http://openjdk.java.net/jeps/191\",\n        children: \"JEP 191 -\\nForeign Function Interface\"\n      }), \", which is\\ntargeted for Java 10. In comparison to JNA, JNR has no proper\\ndocumentation, and you need to look for answers in the source code. That\\nis the main reason for this mini-guide.\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"specialties-of-writing-code-using-java-native-runtime\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#specialties-of-writing-code-using-java-native-runtime\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Specialties of writing code using Java Native Runtime\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"function-binding\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#function-binding\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Function binding\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.em, {\n        children: \"The simplest binding\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-java\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" jnr.ffi.*;\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" jnr.ffi.types.pid_t;\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-comment\",\n          children: \"/**\\n * Gets the process ID of the current process, and that of its parent.\\n */\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"Getpid\"\n        }), \" {\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"interface\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"LibC\"\n        }), \"  {\\n        \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-meta\",\n          children: \"@pid_t\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"long\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"getpid\"\n        }), _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"()\"\n        }), \";\\n        \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-meta\",\n          children: \"@pid_t\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"long\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"getppid\"\n        }), _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"()\"\n        }), \";\\n    }\\n\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"static\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"void\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"main\"\n        }), _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"(String[] args)\"\n        }), \" {\\n        \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"LibC\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"libc\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-operator\",\n          children: \"=\"\n        }), \" LibraryLoader.create(LibC.class).load(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"c\\\"\"\n        }), \");\\n\\n        System.out.println(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"pid=\\\"\"\n        }), \" + libc.getpid() + \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\" parent pid=\\\"\"\n        }), \" + libc.getppid());\\n    }\\n}\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Here we are the loading java library which matches the native interface\\nby name.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In the case of FUSE, we need an interface with method fuse_main_real\\nwhere FuseOperations structure with all callbacks passes as an argument.\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-java\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"interface\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"LibFuse\"\n        }), \" {\\n    \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"int\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"fuse_main_real\"\n        }), _jsxs(_components.span, {\n          className: \"hljs-params\",\n          children: [\"(\", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"int\"\n          }), \" argc, String argv[], FuseOperations op, \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"int\"\n          }), \" op_size, Pointer user_data)\"]\n        }), \";\\n}\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"implementation-of-structures\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#implementation-of-structures\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Implementation of structures\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Often you need to work with structure which is located at a certain\\naddress, for example with fuse_bufvec structure:\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-c\",\n        children: [_jsxs(_components.span, {\n          className: \"hljs-class\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"struct\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title\",\n            children: \"fuse_bufvec\"\n          }), \" {\"]\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" count;\\n    \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" idx;\\n    \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" off;\\n    \", _jsxs(_components.span, {\n          className: \"hljs-class\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"struct\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title\",\n            children: \"fuse_buf\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title\",\n            children: \"buf\"\n          }), \"[1];\"]\n        }), \"\\n};\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"For its implementation, we need to make a successor of jnr.ffi.Struct.\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-java\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" jnr.ffi.*;\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"FuseBufvec\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"extends\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"Struct\"\n        }), \" {\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"FuseBufvec\"\n        }), _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"(jnr.ffi.Runtime runtime)\"\n        }), \" {\\n        \", _jsx(_components.span, {\n          className: \"hljs-built_in\",\n          children: \"super\"\n        }), \"(runtime);\\n    }\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"final\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"count\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"new\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"size_t\"\n        }), \"();\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"final\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"idx\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"new\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"size_t\"\n        }), \"();\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"final\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"size_t\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"off\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-operator\",\n          children: \"=\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"new\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"size_t\"\n        }), \"();\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"final\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"FuseBuf\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable\",\n          children: \"buf\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-operator\",\n          children: \"=\"\n        }), \" inner(\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"new\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"FuseBuf\"\n        }), \"(getRuntime()));\\n}\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"After that, you have to set proper callback implementation into the\\ngetattr field.\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-java\",\n        children: [\"fuseOperations.getattr.set((path, stbuf) -\u003e \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"0\"\n        }), \");\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"enum\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#enum\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Enum\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Enum implementation is not so obvious as other parts of the library. You\\nneed to inherit your enum from jnr.ffi.util.EnumMapper.IntegerEnum and\\nimplement method intValue\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-java\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"enum\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"fuse_buf_flags\"\n        }), \" {\\n    FUSE_BUF_IS_FD    = (\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \"),\\n    FUSE_BUF_FD_SEEK    = (\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"2\"\n        }), \"),\\n    FUSE_BUF_FD_RETRY    = (\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"3\"\n        }), \"),\\n};\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"enum\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"FuseBufFlags\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"implements\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"EnumMapper\"\n        }), \".IntegerEnum {\\n    FUSE_BUF_IS_FD(\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \"),\\n    FUSE_BUF_FD_SEEK(\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"2\"\n        }), \"),\\n    FUSE_BUF_FD_RETRY(\", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"1\"\n        }), \" \u003c\u003c \", _jsx(_components.span, {\n          className: \"hljs-number\",\n          children: \"3\"\n        }), \");\\n\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"private\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"final\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"int\"\n        }), \" value;\\n\\n    FuseBufFlags(\", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"int\"\n        }), \" value) {\\n        \", _jsx(_components.span, {\n          className: \"hljs-built_in\",\n          children: \"this\"\n        }), \".value = value;\\n    }\\n\\n    \", _jsx(_components.span, {\n          className: \"hljs-meta\",\n          children: \"@Override\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"public\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-type\",\n          children: \"int\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"intValue\"\n        }), _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"()\"\n        }), \" {\\n        \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" value;\\n    }\\n}\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"work-with-memory\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#work-with-memory\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Work with memory\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"For working with direct memory wrapper jnr.ffi.Pointer exists.\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"You can allocate memory using jnr.ffi.Memory\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"The entry point of JNR API learning is jnr.ffi.Runtime\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This knowledge is enough to implement a simple cross-platform wrapper\\nfor some native library.\"\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"jnr-fuse\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#jnr-fuse\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"JNR-FUSE\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"What I’ve implemented is a FUSE wrapper in my project jnr-fuse.\\nPreviously I used fuse-jna, but it was a bottleneck in the FS\\nimplementation. During the development, I tried to save compatibility\\nwith the native interface (\u003cfuse.h\u003e).\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"For implementing your own file system, you need to extend\\nru.serce.jnrfuse.FuseStubFS and implement several methods.\\nFuse_operations contain \", _jsx(_components.a, {\n        href: \"http://fuse.sourcearchive.com/documentation/2.8.4-1.4ubuntu1/structfuse__operations.html\",\n        children: \"a lot of\\nmethods\"\n      }), \",\\nbut for getting your FS up and running, you just need to implement\\nseveral methods. It is very easy, \", _jsx(_components.a, {\n        href: \"https://github.com/SerCeMan/jnr-fuse/tree/master/src/main/java/ru/serce/jnrfuse/examples\",\n        children: \"here are some\\nexamples\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Currently, only Linux is supported (x86 and x64).\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Library exists in JCenter.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.em, {\n        children: \"Gradle\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-kotlin\",\n        children: [\"repositories {\\n    jcenter()\\n}\\n\\ndependencies {\\n    compile \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"'com.github.serceman:jnr-fuse:0.1'\"\n        }), \"\\n}\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.em, {\n        children: \"Maven\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-xml\",\n        children: [_jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"repositories\"\n          }), \"\u003e\"]\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"repository\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"id\"\n          }), \"\u003e\"]\n        }), \"central\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"id\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"name\"\n          }), \"\u003e\"]\n        }), \"bintray\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"name\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"url\"\n          }), \"\u003e\"]\n        }), \"http://jcenter.bintray.com\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"url\"\n          }), \"\u003e\"]\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"repository\"\n          }), \"\u003e\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"repositories\"\n          }), \"\u003e\"]\n        }), \"\\n\\n\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"dependencies\"\n          }), \"\u003e\"]\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"dependency\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"groupId\"\n          }), \"\u003e\"]\n        }), \"com.github.serceman\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"groupId\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"artifactId\"\n          }), \"\u003e\"]\n        }), \"jnr-fuse\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"artifactId\"\n          }), \"\u003e\"]\n        }), \"\\n        \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"version\"\n          }), \"\u003e\"]\n        }), \"0.1\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"version\"\n          }), \"\u003e\"]\n        }), \"\\n    \", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"dependency\"\n          }), \"\u003e\"]\n        }), \"\\n\", _jsxs(_components.span, {\n          className: \"hljs-tag\",\n          children: [\"\u003c/\", _jsx(_components.span, {\n            className: \"hljs-name\",\n            children: \"dependencies\"\n          }), \"\u003e\"]\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"jnr-fuse-and-fuse-jna-performance-comparison\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#jnr-fuse-and-fuse-jna-performance-comparison\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"JNR-FUSE and FUSE-JNA performance comparison\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In my case the FS was read-only, and I was interested in throughput. The\\nperformance will mostly depend on your FS implementation, so if you\\nalready use fuse-jna, you’ll be able to change it easily to jnr-fuse,\\nwrite a test, and to see the performance difference on your workload.\\n(It will be helpful anyway because we all love to achieve new levels of\\nperformance, right?)\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In order to show performance the difference, I moved MemoryFS\\nimplementation from fuse-jna to jnr-fuse with minimal changes and ran a\\nreading test. For the test, I used\\n\", _jsx(_components.a, {\n        href: \"http://freecode.com/projects/fio\",\n        children: \"fio\"\n      }), \" framework.\"]\n    }), \"\\n\", _jsxs(\"details\", {\n      children: [_jsx(\"summary\", {\n        children: \"Test configuration\"\n      }), _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"\",\n          children: \"[readtest]\\nblocksize=4k\\ndirectory=/tmp/mnt/\\nrw=randread\\ndirect=1\\nbuffered=0\\nioengine=libaio\\ntime_based=60\\nsize=16M\\nruntime=60\\n\"\n        })\n      })]\n    }), \"\\n\", _jsxs(\"details\", {\n      children: [_jsx(\"summary\", {\n        children: \"The result of of fuse-jna\"\n      }), _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"\",\n          children: \"serce@SerCe-FastLinux:~/git/jnr-fuse/bench$ fio read.ini\\nreadtest: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=1\\nfio-2.1.3\\nStarting 1 process\\nreadtest: Laying out IO file(s) (1 file(s) / 16MB)\\nJobs: 1 (f=1): [r] [100.0% done] [24492KB/0KB/0KB /s] [6123/0/0 iops] [eta 00m:00s]\\nreadtest: (groupid=0, jobs=1): err= 0: pid=10442: Sun Jun 21 14:49:13 2015\\nread: io=1580.2MB, bw=26967KB/s, iops=6741, runt= 60000msec\\nslat (usec): min=46, max=29997, avg=146.55, stdev=327.68\\nclat (usec): min=0, max=69, avg= 0.47, stdev= 0.66\\nlat (usec): min=47, max=30002, avg=147.26, stdev=327.88\\nclat percentiles (usec):\\n| 1.00th=[ 0], 5.00th=[ 0], 10.00th=[ 0], 20.00th=[ 0],\\n| 30.00th=[ 0], 40.00th=[ 0], 50.00th=[ 0], 60.00th=[ 1],\\n| 70.00th=[ 1], 80.00th=[ 1], 90.00th=[ 1], 95.00th=[ 1],\\n| 99.00th=[ 2], 99.50th=[ 2], 99.90th=[ 3], 99.95th=[ 12],\\n| 99.99th=[ 14]\\nbw (KB /s): min=17680, max=32606, per=96.09%, avg=25913.26, stdev=3156.20\\nlat (usec): 2=97.95%, 4=1.96%, 10=0.02%, 20=0.06%, 50=0.01%\\nlat (usec): 100=0.01%\\ncpu: usr=1.98%, sys=5.94%, ctx=405302, majf=0, minf=28\\nIO depths: 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, \u003e=64=0.0%\\nsubmit: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0%\\ncomplete: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0%\\nissued: total=r=404511/w=0/d=0, short=r=0/w=0/d=0\\n\\nRun status group 0 (all jobs):\\nREAD: io=1580.2MB, aggrb=26967KB/s, minb=26967KB/s, maxb=26967KB/s, mint=60000msec, maxt=60000msec\\n\"\n        })\n      })]\n    }), \"\\n\", _jsxs(\"details\", {\n      children: [_jsx(\"summary\", {\n        children: \"The result of jnr-fuse\"\n      }), _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"\",\n          children: \"serce@SerCe-FastLinux:~/git/jnr-fuse/bench$ fio read.ini\\nreadtest: (g=0): rw=randread, bs=4K-4K/4K-4K/4K-4K, ioengine=libaio, iodepth=1\\nfio-2.1.3\\nStarting 1 process\\nreadtest: Laying out IO file(s) (1 file(s) / 16MB)\\nJobs: 1 (f=1): [r] [100.0% done] [208.5MB/0KB/0KB /s] [53.4K/0/0 iops] [eta 00m:00s]\\nreadtest: (groupid=0, jobs=1): err= 0: pid=10153: Sun Jun 21 14:45:17 2015\\nread: io=13826MB, bw=235955KB/s, iops=58988, runt= 60002msec\\nslat (usec): min=6, max=23671, avg=15.80, stdev=19.97\\nclat (usec): min=0, max=1028, avg= 0.37, stdev= 0.78\\nlat (usec): min=7, max=23688, avg=16.29, stdev=20.03\\nclat percentiles (usec):\\n| 1.00th=[ 0], 5.00th=[ 0], 10.00th=[ 0], 20.00th=[ 0],\\n| 30.00th=[ 0], 40.00th=[ 0], 50.00th=[ 0], 60.00th=[ 0],\\n| 70.00th=[ 1], 80.00th=[ 1], 90.00th=[ 1], 95.00th=[ 1],\\n| 99.00th=[ 1], 99.50th=[ 1], 99.90th=[ 2], 99.95th=[ 2],\\n| 99.99th=[ 10]\\nlat (usec): 2=99.88%, 4=0.10%, 10=0.01%, 20=0.01%, 50=0.01%\\nlat (usec): 100=0.01%, 250=0.01%\\nlat (msec): 2=0.01%\\ncpu: usr=9.33%, sys=34.01%, ctx=3543137, majf=0, minf=28\\nIO depths: 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, \u003e=64=0.0%\\nsubmit: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0%\\ncomplete: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0%\\nissued: total=r=3539449/w=0/d=0, short=r=0/w=0/d=0\\n\\nRun status group 0 (all jobs):\\nREAD: io=13826MB, aggrb=235955KB/s, minb=235955KB/s, maxb=235955KB/s, mint=60002msec, maxt=60002msec\\n\"\n        })\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/images/jnr-fuse/table.png\",\n        alt: \"\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The only information this test shows us is the difference in reading a\\nfile using fuse-jna and jnr-fuse, but it gives us an understanding of\\nthe level of performance difference of JNA and JNR. If you are\\ninterested, you can write a more detailed test for native calls using\\nthe \", _jsx(_components.a, {\n        href: \"http://openjdk.java.net/projects/code-tools/jmh/\",\n        children: \"JMH\"\n      }), \" tool.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The performance differences in throughput and latency are about ~10\\ntimes. Charles Nutter in his presentation gave us the same numbers.\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"references\",\n      children: [_jsx(_components.a, {\n        className: \"anchor\",\n        href: \"#references\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"References\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/libfuse/libfuse\",\n          children: \"FUSE on GitHub\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/jnr\",\n          children: \"JNR on GitHub\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"http://www.oracle.com/technetwork/java/jvmls2013nutter-2013526.pdf\",\n          children: \"Charles Nutter presentation about JNR\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"http://openjdk.java.net/jeps/191\",\n          children: \"JEP 191\"\n        })\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.a, {\n          href: \"https://github.com/SerCeMan/jnr-fuse/blob/master/src/main/java/ru/serce/jnrfuse/examples/HelloFuse.java\",\n          children: \"Java HelloFuse\"\n        }), \"\\n/\", _jsx(_components.a, {\n          href: \"https://github.com/libfuse/libfuse/blob/master/example/hello.c\",\n          children: \"CHelloFuse\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The \", _jsx(_components.a, {\n        href: \"https://github.com/SerCeMan/jnr-fuse\",\n        children: \"jnr-fuse\"\n      }), \" project is located\\non GitHub. I’ll appreciate stars, pull-requests, and comments. I’ll be\\nglad to answer any questions you have about JNR or jnr-fuse.\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{"title":"JNR-FUSE library for using FUSE from Java","description":"Empty","date":"2015-06-22"}},"frontMatter":{"title":"JNR-FUSE library for using FUSE from Java","description":"Empty","date":"2015-06-22"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"22-06-2015-jnr-fuse"},"buildId":"Pcyft9E01JztMB997G3j_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>